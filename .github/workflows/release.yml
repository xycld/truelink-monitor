name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build-archlinux:
    name: Build (Arch Linux)
    runs-on: ubuntu-latest
    container: archlinux:base-devel

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          # Avoid full system upgrades in containers (systemd hooks can fail).
          SYSTEMD_OFFLINE=1 pacman -Sy --noconfirm --needed archlinux-keyring

          # Arch package names for Plasma/KF can change over time.
          # Pick the first available candidate without failing the job early.
          pick_pkg() {
            for cand in "$@"; do
              if pacman -Si "$cand" >/dev/null 2>&1; then
                printf '%s\n' "$cand"
                return 0
              fi
            done
            printf '%s\n' ""
            return 0
          }

          # On Arch (Plasma 6), the CMake `Plasma` package is provided by `libplasma`.
          PLASMA_FRAMEWORK="$(pick_pkg libplasma plasma-framework plasma-framework6 plasma-framework5 kf6-plasma)"
          if [ -z "$PLASMA_FRAMEWORK" ]; then
            echo "ERROR: Could not find a Plasma framework package in repos." >&2
            pacman -Ss plasma-framework || true
            exit 1
          fi

          SYSTEMD_OFFLINE=1 pacman -S --noconfirm --needed \
            appstream \
            cmake \
            extra-cmake-modules \
            gcc \
            git \
            kconfig \
            kcoreaddons \
            ki18n \
            libnl \
            networkmanager \
            networkmanager-qt \
            "$PLASMA_FRAMEWORK" \
            pkgconf \
            qt6-base \
            qt6-declarative

      - name: Configure
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --parallel

      - name: Test
        run: ctest --test-dir build --output-on-failure

      - name: Validate AppStream
        run: appstreamcli validate --no-net org.kde.plasma.truelinkmonitor.metainfo.xml

  publish:
    name: Publish GitHub Release
    needs: build-archlinux
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare source tarball
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          tarball="truelink-monitor-${tag}.tar.gz"

          git archive --format=tar.gz \
            --prefix="truelink-monitor-${tag}/" \
            -o "${tarball}" \
            "${tag}"

          sha256sum "${tarball}" | tee "${tarball}.sha256"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            truelink-monitor-${{ github.ref_name }}.tar.gz
            truelink-monitor-${{ github.ref_name }}.tar.gz.sha256

  aur:
    name: Publish AUR
    needs: publish
    runs-on: ubuntu-latest
    container: archlinux:base-devel

    steps:
      # NOTE: `secrets.*` is not available in job-level `if:` expressions.
      # Use a step output to guard the rest of the job.
      - name: Check AUR configuration
        id: aur_config
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${AUR_SSH_PRIVATE_KEY}" ]; then
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "AUR_SSH_PRIVATE_KEY not set; skipping AUR publish."
            exit 0
          fi
          echo "enabled=true" >> "$GITHUB_OUTPUT"
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}

      - name: Install tools
        if: ${{ steps.aur_config.outputs.enabled == 'true' }}
        run: |
          set -euo pipefail
          SYSTEMD_OFFLINE=1 pacman -Sy --noconfirm --needed archlinux-keyring
          SYSTEMD_OFFLINE=1 pacman -S --noconfirm --needed \
            base-devel \
            curl \
            git \
            openssh

      - name: Checkout
        if: ${{ steps.aur_config.outputs.enabled == 'true' }}
        uses: actions/checkout@v4

      - name: Configure SSH
        if: ${{ steps.aur_config.outputs.enabled == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          umask 077
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Persist the key for subsequent steps (ssh-agent does not persist across steps).
          printf '%s\n' "${AUR_SSH_PRIVATE_KEY}" > ~/.ssh/aur_key
          chmod 600 ~/.ssh/aur_key

          # AUR may not advertise an ed25519 host key; scan all supported types.
          ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

          # Non-interactive SSH for git in later steps.
          echo "GIT_SSH_COMMAND=ssh -i $HOME/.ssh/aur_key -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" >> "$GITHUB_ENV"
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}

      - name: Check AUR access
        id: aur_access
        if: ${{ steps.aur_config.outputs.enabled == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          repo="ssh://aur@aur.archlinux.org/plasma6-applet-truelink-monitor.git"
          if GIT_SSH_COMMAND="$GIT_SSH_COMMAND" git ls-remote "$repo" HEAD >/dev/null 2>&1; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "AUR SSH key cannot access ${repo}; skipping AUR publish." >&2
          fi

      - name: Update and push AUR repo
        if: ${{ steps.aur_config.outputs.enabled == 'true' && steps.aur_access.outputs.enabled == 'true' }}
        shell: bash
        run: |
          set -euo pipefail

          # Force git to use the configured AUR key in CI.
          export GIT_SSH_COMMAND="ssh -i $HOME/.ssh/aur_key -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"

          tag="${GITHUB_REF_NAME}"
          ver="${tag#v}"

          sha_url="https://github.com/${GITHUB_REPOSITORY}/releases/download/${tag}/truelink-monitor-${tag}.tar.gz.sha256"
          sha256="$(curl -fsSL "${sha_url}" | awk '{print $1}')"
          if [ -z "${sha256}" ]; then
            echo "ERROR: failed to read sha256 from ${sha_url}" >&2
            exit 1
          fi

          tmpdir="$(mktemp -d)"
          git clone "ssh://aur@aur.archlinux.org/plasma6-applet-truelink-monitor.git" "${tmpdir}/aur"
          cd "${tmpdir}/aur"

          cp "${GITHUB_WORKSPACE}/packaging/aur/PKGBUILD" ./PKGBUILD

          # Update version and checksum to match the release.
          perl -pi -e "s/^pkgver=.*/pkgver=${ver}/" PKGBUILD
          perl -pi -e "s/^sha256sums=\('.*'\)/sha256sums=('${sha256}')/" PKGBUILD

          makepkg --printsrcinfo > .SRCINFO

          git add PKGBUILD .SRCINFO
          if git diff --cached --quiet; then
            echo "AUR repo already up to date"
            exit 0
          fi

          git -c user.name="github-actions" -c user.email="actions@github.com" \
            commit -m "Update to ${tag}"
          git push origin HEAD:master
