name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build-archlinux:
    name: Build (Arch Linux)
    runs-on: ubuntu-latest
    container: archlinux:base-devel

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          # Avoid full system upgrades in containers (systemd hooks can fail).
          SYSTEMD_OFFLINE=1 pacman -Sy --noconfirm --needed archlinux-keyring

          # Arch package names for Plasma/KF can change over time.
          # Pick the first available candidate without failing the job early.
          pick_pkg() {
            for cand in "$@"; do
              if pacman -Si "$cand" >/dev/null 2>&1; then
                printf '%s\n' "$cand"
                return 0
              fi
            done
            printf '%s\n' ""
            return 0
          }

          # On Arch (Plasma 6), the CMake `Plasma` package is provided by `libplasma`.
          PLASMA_FRAMEWORK="$(pick_pkg libplasma plasma-framework plasma-framework6 plasma-framework5 kf6-plasma)"
          if [ -z "$PLASMA_FRAMEWORK" ]; then
            echo "ERROR: Could not find a Plasma framework package in repos." >&2
            pacman -Ss plasma-framework || true
            exit 1
          fi

          SYSTEMD_OFFLINE=1 pacman -S --noconfirm --needed \
            appstream \
            cmake \
            extra-cmake-modules \
            gcc \
            git \
            kconfig \
            kcoreaddons \
            ki18n \
            libnl \
            networkmanager \
            networkmanager-qt \
            "$PLASMA_FRAMEWORK" \
            pkgconf \
            qt6-base \
            qt6-declarative

      - name: Configure
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --parallel

      - name: Test
        run: ctest --test-dir build --output-on-failure

      - name: Validate AppStream
        run: appstreamcli validate --no-net org.kde.plasma.truelinkmonitor.metainfo.xml

  publish:
    name: Publish GitHub Release
    needs: build-archlinux
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare source tarball
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          tarball="truelink-monitor-${tag}.tar.gz"

          git archive --format=tar.gz \
            --prefix="truelink-monitor-${tag}/" \
            -o "${tarball}" \
            "${tag}"

          sha256sum "${tarball}" | tee "${tarball}.sha256"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            truelink-monitor-${{ github.ref_name }}.tar.gz
            truelink-monitor-${{ github.ref_name }}.tar.gz.sha256
